<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Bart Smeets" />

<meta name="date" content="2017-04-13" />

<title>Getting started with jug</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Getting started with jug</h1>
<h4 class="author"><em>Bart Smeets</em></h4>
<h4 class="date"><em>2017-04-13</em></h4>



<p><em>generated using jug version 0.1.7</em></p>
<div id="hello-world" class="section level2">
<h2><a name="hello"></a>Hello World!</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(jug)

<span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">get</span>(<span class="st">&quot;/&quot;</span>, function(req, res, err){
    <span class="st">&quot;Hello World!&quot;</span>
  }) %&gt;%
<span class="st">  </span><span class="kw">simple_error_handler_json</span>() %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<pre><code>Serving the jug at http://127.0.0.1:8080</code></pre>
</div>
<div id="what-is-jug" class="section level2">
<h2>What is jug?</h2>
<p>jug is a small web development framework for R which relies heavily upon the <code>httpuv</code> package. It’s main focus is to make building APIs for your code as easy as possible.</p>
<p>jug is not supposed to be either an especially performant nor an uber stable web framework. Other tools (and languages) might be more suited for that. It’s main focus is to easily allow you to create APIs for your R code. However, the flexibility of jug means that, in theory, you could built an extensive web framework with it.</p>
</div>
<div id="getting-started" class="section level2">
<h2>Getting started</h2>
<p>To install the latest version use <code>devtools</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">&quot;Bart6114/jug&quot;</span>)</code></pre></div>
<p>Or install the CRAN version:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packags</span>(<span class="st">&quot;jug&quot;</span>)</code></pre></div>
<p>Load the library:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(jug)</code></pre></div>
</div>
<div id="the-jug-instance" class="section level2">
<h2>The jug instance</h2>
<p>Everything starts with a jug instance. This instance is created by simply calling <code>jug()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>()</code></pre></div>
<pre><code>## A Jug instance with 0 middlewares attached</code></pre>
<p>jug is made to work closely with the piping functionality of <code>magrittr</code> (<code>%&gt;%</code>). The configuration of the jug instance is set up by piping the instance through the various functions explained below.</p>
</div>
<div id="middleware" class="section level2">
<h2>Middleware</h2>
<p>In terms of middleware, jug somewhat follows the specification of middleware by <code>Express</code>. In jug, middleware is a function with access to the <strong>request</strong> (<code>req</code>), <strong>response</strong> (<code>res</code>) and <strong>error</strong> (<code>err</code>) object.</p>
<p>Multiple middlewares can be defined. The order in which the middlewares are added matters. A request will start with being passed through the first middleware added (more specifically the functions specified in it - see next paragraph). It will continue to be passed through the added middlewares until a middleware does not return <code>NULL</code> (note: if a value is set using e.g. <code>res$json(&quot;foo&quot;)</code> the body will not be <code>NULL</code>). Whatever will be passed by that middleware will be set as the response body.</p>
<p>Most middleware will accept a <code>func</code> or <code>...</code> argument to which respectively a function or multiple functions can be passed. If multiple functions are passed; the order in which they are passed will be respected when processing a request. To each function the <code>req</code>, <code>res</code> and <code>err</code> objects will be passed (and they thus should accept them).</p>
<div id="method-insensitive-middleware" class="section level3">
<h3>Method insensitive middleware</h3>
<p>The <code>use</code> function is a method insensitive middleware specifier. While it is method insensitive, it can be bound to a specific path. If the <code>path</code> argument (accepts a regex string with <code>grepl</code> setting <code>perl=TRUE</code>) is set to <code>NULL</code> it also becomes path insensitive and will process <em>every</em> request.</p>
<p>A path insensitive example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">use</span>(<span class="dt">path =</span> <span class="ot">NULL</span>, function(req, res, err){
    <span class="st">&quot;test 1,2,3!&quot;</span>
    }) %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<pre><code>$ curl 127.0.0.1:8080/xyz
test 1,2,3!</code></pre>
<p>The same example, but path sensitive:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">use</span>(<span class="dt">path =</span> <span class="st">&quot;/&quot;</span>, function(req, res, err){
    <span class="st">&quot;test 1,2,3!&quot;</span>
    }) %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<pre><code>$ curl 127.0.0.1:8080/xyz
curl: (52) Empty reply from server

$ curl 127.0.0.1:8080
test 1,2,3!</code></pre>
<p>It is however possible to specify a method to bind to using <code>use</code> (check out <code>?use</code>), this way you can process request methods for which no prespecified middlewares exist.</p>
<p>Note that in the above example errors / missing route handling is missing (the server might crash / not respond), more on that later.</p>
</div>
<div id="method-sensitive-middleware" class="section level3">
<h3>Method sensitive middleware</h3>
<p>In the same style as the request method insensitive middleware, there is request method sensitive middleware available. More specifically, you can use the <code>get</code>, <code>post</code>, <code>put</code> and <code>delete</code> functions.</p>
<p>This type of middleware is bound to a path using the <code>path</code> argument. If <code>path</code> is set to <code>NULL</code> it will bind to every request to the path, given that it is of the corresponding request method.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">get</span>(<span class="dt">path =</span> <span class="st">&quot;/&quot;</span>, function(req, res, err){
    <span class="st">&quot;get test 1,2,3!&quot;</span>
    }) %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<pre><code>$ curl 127.0.0.1:8080
get test 1,2,3!</code></pre>
<p>Middlewares are meant to be chained, so to bind different functions to different paths:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">get</span>(<span class="dt">path =</span> <span class="st">&quot;/&quot;</span>, function(req, res, err){
    <span class="st">&quot;get test 1,2,3 on path /&quot;</span>
    }) %&gt;%
<span class="st">  </span><span class="kw">get</span>(<span class="dt">path =</span> <span class="st">&quot;/my_path&quot;</span>, function(req, res, err){
    <span class="st">&quot;get test 1,2,3 on path /my_path&quot;</span>
    }) %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<pre><code>$ curl 127.0.0.1:8080
get test 1,2,3 on path /

$ curl 127.0.0.1:8080/my_path
get test 1,2,3 on path /my_path</code></pre>
</div>
<div id="websocket-protocol" class="section level3">
<h3>Websocket protocol</h3>
<p>By default all middleware convenience function bind to the http protocol. You can however access the jug server through websocket by using the websocket sensitive middleware function <code>ws</code>. Below an example echo’ing the incoming message.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>() %&gt;%
<span class="st">   </span><span class="kw">ws</span>(<span class="st">&quot;/echo_message&quot;</span>, function(binary, message, res, err){
    message
  }) %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<p>Opening a connection to <code>ws://127.0.0.1:8080/echo_message</code> and sending e.g. the message <code>test</code> to it will then return the value <code>test</code>.</p>
<p><strong>Please note that websocket support is experimental at this stage.</strong></p>
</div>
<div id="including-elsewhere-defined-middleware-chains" class="section level3">
<h3>Including elsewhere defined middleware chains</h3>
<p>In order to make you code more modular, you can include elsewhere defined middleware chains into your jug instance. To do this you can use a combination of the <code>collector()</code> and <code>include()</code> functions.</p>
<p>Below a <code>collector</code> is defined locally (in the same R script) and <code>include</code>d.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> collected_mw&lt;-
<span class="st">    </span><span class="kw">collector</span>() %&gt;%
<span class="st">    </span><span class="kw">get</span>(<span class="st">&quot;/&quot;</span>, function(req,res,err){
      <span class="kw">return</span>(<span class="st">&quot;test&quot;</span>)
    })

  res&lt;-<span class="kw">jug</span>() %&gt;%
<span class="st">    </span><span class="kw">include</span>(collected_mw) %&gt;%
<span class="st">    </span><span class="kw">serve_it</span>()</code></pre></div>
<p>However, it is also possible to <code>include</code> a <code>collector</code> that is defined in another .R file.</p>
<p>Let’s say below is the file <code>my_middlewares.R</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(jug)

collected_mw&lt;-
<span class="st">  </span><span class="kw">collector</span>() %&gt;%
<span class="st">  </span><span class="kw">get</span>(<span class="st">&quot;/&quot;</span>, function(req,res,err){
    <span class="kw">return</span>(<span class="st">&quot;test2&quot;</span>)
  })</code></pre></div>
<p>We can include it as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res&lt;-<span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">include</span>(collected_mw, <span class="st">&quot;my_middlewares.R&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
</div>
</div>
<div id="predefined-middleware" class="section level2">
<h2>Predefined middleware</h2>
<div id="error-handling" class="section level3">
<h3>Error handling</h3>
<p>A simple error handling middleware (<code>simple_error_handler</code> / <code>simple_error_handler_json</code>) which catches unbound paths and <code>func</code> evaluation errors. If you do not implement a custom error handler, I suggest you add either of these to your jug instance. The <code>simple_error_handler</code> returns an HTML error page while the <code>simple_error_handler_json</code> returns a JSON message.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">simple_error_handler</span>() %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<pre><code>$ curl 127.0.0.1:8080
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;Not found&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;No handler bound to path&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>If you want to implement your own custom error handling just have a look at the code of these simple error handling middlewares.</p>
<p>Please note that generally you would like the error handler middleware to be attached to the jug instance after all other middleware has been specified.</p>
</div>
<div id="easily-using-your-own-functions" class="section level3">
<h3>Easily using your own functions</h3>
<p>The main reason jug was created is to easily allow access to your own custom R functions. The convenience function <code>decorate</code> is built especially for this purpose.</p>
<p>If you <code>decorate</code> your own function it will translate all arguments passed in the query string of the request as arguments to your function. It will also pass all headers to the function as arguments.</p>
<p>If your function does not accept a <code>...</code> argument, all query/header parameters that are not explicitly requested by your function are dropped. If your function requests a <code>req</code>, <code>res</code> or <code>err</code> argument (or <code>...</code>) the corresponding objects will be passed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">say_hello&lt;-function(name){<span class="kw">paste</span>(<span class="st">&quot;hello&quot;</span>,name,<span class="st">&quot;!&quot;</span>)}

<span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">get</span>(<span class="st">&quot;/&quot;</span>, <span class="kw">decorate</span>(say_hello)) %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<p>If in the above, you pass a parameter <code>name</code> through either the query string or as a header in the GET request, it will return as in the example below.</p>
<pre><code>$ curl 127.0.0.1:8080/?name=Bart
hello Bart !</code></pre>
</div>
<div id="static-file-server" class="section level3">
<h3>Static file server</h3>
<p>The <code>serve_static_file</code> middleware allows for serving static files.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">serve_static_files</span>() %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<p>The default root directory is the one returned by <code>getwd()</code> but can be specified by providing a <code>root_path</code> argument to the <code>serve_static_files</code> middleware. It transforms a bare <code>/</code> path to <code>index.html</code>.</p>
<p>Aside from development, I do not recommend using jug to serve static files.</p>
</div>
<div id="cors-functionality" class="section level3">
<h3>CORS functionality</h3>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">CORS functionality</a> is introduced by the <code>cors()</code> middleware function.</p>
<p>Consider the following example.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">cors</span>() %&gt;%
<span class="st">  </span><span class="kw">get</span>(<span class="st">&quot;/&quot;</span>, function(req, res, err){
    <span class="st">&quot;Hello World!&quot;</span>
  }) %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<pre><code>$ curl -v 127.0.0.1:8080/
*   Trying 127.0.0.1...
* Connected to 127.0.0.1 (127.0.0.1) port 8080 (#0)
&gt; GET / HTTP/1.1
&gt; Host: 127.0.0.1:8080
&gt; User-Agent: curl/7.43.0
&gt; Accept: */*
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Content-Type: text/html
&lt; Access-Control-Allow-Origin: *
&lt; Access-Control-Allow-Methods: POST,GET,PUT,OPTIONS,DELETE,PATCH
&lt; Content-Length: 12
&lt; 
* Connection #0 to host 127.0.0.1 left intact</code></pre>
<p>As you see this adds some default CORS-headers. Check out <code>?cors</code> for the configuration options, note that you can also add CORS headers to a specific path by specifying the <code>path</code> parameter.</p>
</div>
<div id="authentication" class="section level3">
<h3>Authentication</h3>
<p>Currently there is only built-in support for basic authentication (check: <a href="https://www.httpwatch.com/httpgallery/authentication/" class="uri">https://www.httpwatch.com/httpgallery/authentication/</a>) through the <code>auth_basic</code> middleware function. The middleware will check the request for a valid username / password combination. If an invalid combination is passed, it will return a 401 status, a <code>WWW-Authenticate</code> header and a text body which states that there was an authentication error.</p>
<p>First you will need to define a function that accepts <code>username</code> and <code>password</code> arguments. The funtion should return <code>TRUE</code> if the combination is valid and <code>FALSE</code> if the combination is invalid. A dummy example is shown below. Note, that this function could also check e.g. a database to validate the combo.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># dummy account checker</span>
account_checker &lt;-<span class="st"> </span>function(username, password){
  <span class="co"># do something to verify the username and password and return TRUE if combination OK</span>
  <span class="kw">all</span>(username ==<span class="st"> &quot;test_user&quot;</span>, 
      password ==<span class="st"> &quot;test_password&quot;</span>)
}</code></pre></div>
<p>Next you need to instantiate the <code>auth_basic</code> middleware in you middleware chain. The <code>auth_basic</code> function accepts as first parameter the username/password validation function. Below two examples are given. The first one shows how to do authentication for a specific path (<code>/test</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">get</span>(<span class="st">&quot;/&quot;</span>, function(req, res, err){
    <span class="st">&quot;/ req&quot;</span>
  }) %&gt;%
<span class="st">  </span><span class="kw">get</span>(<span class="st">&quot;/test&quot;</span>, <span class="kw">auth_basic</span>(account_checker), function(req, res, err){
    <span class="st">&quot;/test req&quot;</span>
  }) %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<p>The second example below shows how to activate basic authentication for all paths in the jug instance.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">use</span>(<span class="ot">NULL</span>, <span class="kw">auth_basic</span>(account_checker)) %&gt;%
<span class="st">  </span><span class="kw">get</span>(<span class="st">&quot;/&quot;</span>, function(req, res, err){
    <span class="st">&quot;/ req&quot;</span>
  }) %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
</div>
</div>
<div id="the-request-response-and-error-objects" class="section level2">
<h2>The request, response and error objects</h2>
<div id="request-req-object" class="section level3">
<h3>Request (<code>req</code>) object</h3>
<p>The <code>req</code> object contains the request specifications. It has different attributes:</p>
<ul>
<li><code>req$params</code> a named list of the parameters passed by either the query string, a JSON body, URL parameters or a multipart form</li>
<li><code>req$path</code> the request path</li>
<li><code>req$method</code> the request method</li>
<li><code>req$raw</code> the raw request object as passsed by <code>httpuv</code></li>
<li><code>req$body</code> the full request body as a character string</li>
<li><code>req$protocol</code> either <code>http</code> or <code>websocket</code></li>
<li><code>req$headers</code> a named list of the headers in the request (as lowercase and stripped from the <code>HTTP_</code> prefix provided by the underlying <code>httpuv</code> framework)</li>
</ul>
<p>It has the following functions attached to it:</p>
<ul>
<li><code>req$get_header(key)</code> returns the value associated to the specified key in the request (no need to worry about the <code>HTTP_</code> prefix)</li>
<li><code>req$set_header(key, value)</code> allows to set / alter a header while processing the request (can be useful to pass data to the next middleware)</li>
<li><code>req$attach(key, value)</code> attach a variable to <code>req$params</code></li>
</ul>
</div>
<div id="response-res-object" class="section level3">
<h3>Response (<code>res</code>) object</h3>
<p>The <code>res</code> object contains the response specifications. It has different attributes:</p>
<ul>
<li><code>res$headers</code> a named list of the set headers</li>
<li><code>res$status</code> the status of the response (defaults to 200)</li>
<li><code>res$body</code> the body of the response (is automatically set to be the content of the not <code>NULL</code> returning middleware or by methods such as <code>res$json()</code>)</li>
</ul>
<p>It also has a set of functions:</p>
<ul>
<li><code>res$set_header(key, value)</code> set a custom header</li>
<li><code>res$content_type(type)</code> set your own content type (MIME)</li>
<li><code>res$set_status(status)</code> set the status of the response</li>
<li><code>res$text(body)</code> to explicitely set the body of the response</li>
<li><code>res$json(obj, auto_unbox=TRUE)</code> converts an object to JSON, sets it as the body and set the correct content type</li>
<li><code>res$plot(plot_obj, base64=TRUE)</code> convenience function to return a plot object as the response body, the returned plot can either be a base64 representation of the image (default) or the actual binary data</li>
</ul>
</div>
<div id="error-err-object" class="section level3">
<h3>Error (<code>err</code>) object</h3>
<p>The <code>err</code> object contains a list of errors, accessible through <code>err$errrors</code>. You can add an error to this list by calling <code>err$set(error)</code>. The error will be converted to a character.</p>
<p>Refer to the “Error handling” paragraph for more details.</p>
</div>
</div>
<div id="url-dispatching" class="section level2">
<h2>URL dispatching</h2>
<p>The path parameter in the <code>get</code>, <code>post</code>, … functions are processed as being regex patterns.</p>
<p>If there are named capture groups in the path definition, they will be attached to the <code>req$params</code> object. For example the pattern <code>/test/(?&lt;id&gt;.*)/(?&lt;id2&gt;.*)</code> will result in the variables <code>id</code> and <code>id2</code> (with their respective values) being bound to the <code>req$params</code> object.</p>
<p>If a path pattern is not started with a start of string <code>^</code> regex token <strong>or</strong> ended with an end of string token <code>$</code>, these will be explicitely inserted at respectively the beginning and end of the path pattern specification. For example the path pattern <code>/</code> will be converted to <code>^/$</code>.</p>
</div>
<div id="starting-the-jug-instance" class="section level2">
<h2>Starting the jug instance</h2>
<p>Simply call <code>serve_it()</code> at the end of your piping chain (see <a href="#hello">Hello World!</a> example).</p>
</div>
<div id="practical-examples" class="section level2">
<h2>Practical examples</h2>
<div id="minimal-crud-todo-app" class="section level3">
<h3>Minimal CRUD TODO app</h3>
<p>A minimal TODO app built in Angular with a jug backend.</p>
<p>Clone the repository to check it out: <a href="https://github.com/Bart6114/jug-crud-example">github.com/Bart6114/jug-crud-example</a></p>
</div>
<div id="exposing-a-machine-learning-model" class="section level3">
<h3>Exposing a machine learning model</h3>
<p>Let’s train (in a very simplistic way) a linear regression model on the <code>mtcars</code> dataset and assume that our objective is to predict the miles per gallon or <code>mpg</code> variable based on the inputs <code>gear</code> and <code>hp</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(mtcars)</code></pre></div>
<pre><code>##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb
## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg_model&lt;-
<span class="st">  </span><span class="kw">lm</span>(mpg~gear+hp, <span class="dt">data=</span>mtcars)

<span class="kw">summary</span>(mpg_model)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = mpg ~ gear + hp, data = mtcars)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -4.7977 -2.4288 -0.7685  2.2405  7.5943 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 17.755144   3.241809   5.477 6.74e-06 ***
## gear         3.176520   0.762584   4.165 0.000255 ***
## hp          -0.063931   0.008206  -7.791 1.36e-08 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 3.108 on 29 degrees of freedom
## Multiple R-squared:  0.7513, Adjusted R-squared:  0.7341 
## F-statistic: 43.79 on 2 and 29 DF,  p-value: 1.731e-09</code></pre>
<p>As we went through a lot of hard work to end up with this model (/s), we now want to expose it through an API. This way we allow other people or applications to make predictions using this model.</p>
<p>As a first step we need to build a minimal prediction function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predict_mpg &lt;-<span class="st"> </span>function(gear, hp){
  <span class="kw">predict</span>(mpg_model, 
          <span class="dt">newdata =</span> <span class="kw">data.frame</span>(<span class="dt">gear=</span><span class="kw">as.numeric</span>(gear), 
                               <span class="dt">hp=</span><span class="kw">as.numeric</span>(hp)))[[<span class="dv">1</span>]]
}</code></pre></div>
<p>We can test the function by supplying the <code>gear</code> and <code>hp</code> arguments.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">predict_mpg</span>(<span class="dt">gear =</span> <span class="dv">4</span>, <span class="dt">hp =</span> <span class="dv">80</span>)</code></pre></div>
<pre><code>## [1] 25.34671</code></pre>
<p>Now, to expose this function as a we API, we need to build a <code>jug</code> instance. We can use the built-in <code>decorate</code> middleware to ease the integration of the <code>predict_mpg</code> function. Below, a minimal example is shown.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">jug</span>() %&gt;%
<span class="st">  </span><span class="kw">post</span>(<span class="st">&quot;/predict-mpg&quot;</span>, <span class="kw">decorate</span>(predict_mpg)) %&gt;%
<span class="st">  </span><span class="kw">simple_error_handler_json</span>() %&gt;%
<span class="st">  </span><span class="kw">serve_it</span>()</code></pre></div>
<pre><code>Serving the jug at http://127.0.0.1:8080</code></pre>
<p>We can now send a http POST request to the <code>http://127.0.0.1:8080/predict-mpg</code> url and it will return the predicted value! It works out of the box with either the parameters in a JSON body, as <code>multipart/form-data</code> or as a <code>x-www-form-urlencoded</code>.</p>
<p><strong>JSON body</strong></p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">curl</span> -X POST \
  http://127.0.0.1:8080/predict-mpg \
  -H <span class="st">'content-type: application/json'</span> \
  -d <span class="st">'{&quot;hp&quot;: 80, &quot;gear&quot;: 4}'</span></code></pre></div>
<p><strong>multipart form</strong></p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">curl</span> -X POST \
  http://127.0.0.1:8080/predict-mpg \
  -H <span class="st">'content-type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW'</span> \
  -F hp=80 \
  -F gear=4</code></pre></div>
<p><strong>urlencode form</strong></p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">curl</span> -X POST \
  http://127.0.0.1:8080/predict-mpg \
  -H <span class="st">'content-type: application/x-www-form-urlencoded'</span> \
  -d <span class="st">'gear=4&amp;hp=80'</span></code></pre></div>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
